




[include DEMON_ESSENTIALS/*.cfg]
[include PROBE STUFF/*.cfg]
[include STEPPERS/*.cfg]
[include K-ShakeTune/*.cfg]
[include stealthburner_leds.cfg]
[include DANGER.cfg]
[include ebb36_adxl.cfg]
[include mainsail.cfg]
[exclude_object]
[pause_resume]
[display_status]
[gcode_arcs]
resolution: 0.1
[respond]
default_type: command
[force_move]
enable_force_move: True
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT
[idle_timeout]
timeout: 1800

###
###
###

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_1C0019000C51313236343430-if00

[mcu EBB36]
canbus_uuid: 4b7737adc044

###
###
###

[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 3000             #Max 4000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

###
###
###



# [stepper_x]
# step_pin: PC13
# dir_pin: !PC14
# enable_pin: !PE6
# rotation_distance: 40
# microsteps: 32
# full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
# endstop_pin: tmc5160_stepper_x:virtual_endstop
# position_min: 0
# position_endstop: 345
# position_max: 345
# homing_speed: 150   #Max 100
# homing_retract_dist: 10
# homing_positive_dir: true
# use_sensorless_homing: true


# [tmc5160 stepper_x] 
# cs_pin: PG14
# spi_software_miso_pin: PE13
# spi_software_mosi_pin: PE14
# spi_software_sclk_pin: PE12
# diag1_pin: ^!PF0
# interpolate: True
# driver_SGT: 2       # -64 is most sensitive value, 63 is least sensitive
# run_current: 2.0
# home_current: 0.8
# sense_resistor: 0.075
# stealthchop_threshold: 0


# [stepper_x1]
# step_pin: PE4
# dir_pin: !PE5
# enable_pin: !PE3
# rotation_distance: 40
# microsteps: 32
# full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper



# [tmc5160 stepper_x1] 
# cs_pin: PG13
# spi_software_miso_pin: PE13
# spi_software_mosi_pin: PE14
# spi_software_sclk_pin: PE12
# interpolate: True
# run_current: 2.0
# home_current: 0.1
# sense_resistor: 0.075
# stealthchop_threshold: 0



# [stepper_y] # Connected to motor 4
# step_pin: PB8
# dir_pin: !PB9
# enable_pin: !PB7
# rotation_distance: 40
# microsteps: 32
# full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
# endstop_pin: tmc5160_stepper_y:virtual_endstop
# position_min: 0
# position_endstop: 365
# position_max: 365
# homing_speed: 150  #Max 100
# homing_retract_dist: 5
# homing_positive_dir: True
# use_sensorless_homing: true


# [tmc5160 stepper_y] 
# cs_pin: PG11
# spi_software_miso_pin: PE13
# spi_software_mosi_pin: PE14
# spi_software_sclk_pin: PE12
# diag1_pin: ^!PF3
# interpolate: True
# driver_SGT: 3  # -64 is most sensitive value, 63 is least sensitive
# run_current: 2.0
# home_current: 0.8
# sense_resistor: 0.075
# stealthchop_threshold: 0


# [stepper_y1] # Connected to motor 5
# step_pin: PB5
# dir_pin: !PB4
# enable_pin: !PB6
# rotation_distance: 40
# microsteps: 32
# full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper


# [tmc5160 stepper_y1] 
# cs_pin: PG10
# spi_software_miso_pin: PE13
# spi_software_mosi_pin: PE14
# spi_software_sclk_pin: PE12
# interpolate: True
# run_current: 2.0
# home_current: 0.1
# sense_resistor: 0.075
# stealthchop_threshold: 0


# #####################################################################
# #   Z Stepper Settings
# #####################################################################

# ## Z0 Stepper - Front Left
# ##  Connected to MOTOR_2
# ##  Endstop connected to DIAG_2
# [stepper_z]
# step_pin: PG15
# dir_pin: !PB3
# enable_pin: !PD5
# rotation_distance: 40
# gear_ratio: 80:16
# microsteps: 32
# endstop_pin: PF4
# ##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
# ##  (+) value = endstop above Z0, (-) value = endstop below
# ##  Increasing position_endstop brings nozzle closer to the bed
# ##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
# position_endstop: -0.5
# position_max: 310
# position_min: -5
# homing_speed: 8
# second_homing_speed: 3
# homing_retract_dist: 3

# ##  Make sure to update below for your relevant driver (2208 or 2209)
# [tmc2209 stepper_z]
# uart_pin: PG9
# interpolate: false
# run_current: 0.8
# sense_resistor: 0.110
# stealthchop_threshold: 0

# ##  Z1 Stepper - Rear Left
# ##  Connected to MOTOR_3
# [stepper_z1]
# step_pin: PD3
# dir_pin: PD2
# enable_pin: !PD4
# rotation_distance: 40
# gear_ratio: 80:16
# microsteps: 32

# ##  Make sure to update below for your relevant driver (2208 or 2209)
# [tmc2209 stepper_z1]
# uart_pin: PD7
# interpolate: false
# run_current: 0.8
# sense_resistor: 0.110
# stealthchop_threshold: 0

# ##  Z2 Stepper - Rear Right
# ##  Connected to MOTOR_4
# [stepper_z2]
# step_pin: PA10
# dir_pin: !PA9
# enable_pin: !PA15
# rotation_distance: 40
# gear_ratio: 80:16
# microsteps: 32

# ##  Make sure to update below for your relevant driver (2208 or 2209)
# [tmc2209 stepper_z2]
# uart_pin: PD6
# interpolate: false
# run_current: 0.8
# sense_resistor: 0.110
# stealthchop_threshold: 0

# ##  Z3 Stepper - Front Right
# ##  Connected to MOTOR_5
# [stepper_z3]
# step_pin: PA8
# dir_pin: PC7
# enable_pin: !PC9
# rotation_distance: 40
# gear_ratio: 80:16
# microsteps: 32

# ##  Make sure to update below for your relevant driver (2208 or 2209)
# [tmc2209 stepper_z3]
# uart_pin: PG8
# interpolate: false
# run_current: 0.8
# sense_resistor: 0.110
# stealthchop_threshold: 0


# #####################################################################
# #   Extruder
# #####################################################################
# [extruder]
# step_pin: PD0
# dir_pin: PD1
# enable_pin: !EBB36:PD2
# rotation_distance: 22.6789511   
# # gear_ratio: 50:10
# microsteps: 32
# full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
# nozzle_diameter: 0.400
# filament_diameter: 1.75
# heater_pin: EBB36:PB13
# sensor_type: PT100 INA826    #MAX31865  #ATC Semitec 104NT-4-R025H42G
# sensor_pin: EBB36:PA3
# # sensor_pin: EBB36:PA4
# # spi_bus: spi1
# # rtd_nominal_r: 100
# # rtd_reference_r: 430
# # rtd_num_of_wires: 2              
# min_temp: 10
# max_temp: 300
# max_power: 1.0
# min_extrude_temp: 10
# control = pid
# pid_kp = 26.213
# pid_ki = 1.304
# pid_kd = 131.721
# pressure_advance: 0.05
# pressure_advance_smooth_time: 0.040


# [tmc2209 extruder]
# uart_pin: PE1
# interpolate: false
# run_current: 0.5
# sense_resistor: 0.110
# stealthchop_threshold: 0

[fan]
##	Part Cooling Fan
pin: !PA5
max_power: 1
cycle_time: 0.002
hardware_pwm: false
shutdown_speed: 0

[output_pin CPAP_Power]
pin: PA0
pwm: false
value: 1
shutdown_value: 0
############################

[heater_fan hotend_fan]
pin: PA3     # FAN3    5v hotend heatbreak fan
max_power: 1.0
kick_start_time: 0.100
heater: extruder
heater_temp: 50.0
#  If you are experiencing back flow, you can reduce fan_speed
fan_speed: 1.0

#####################################################################
#   Bed Heater
#####################################################################
[heater_bed]
heater_pin: PF6
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PB1
max_power: 1.0
min_temp: 0
max_temp: 200
control = pid
pid_kp = 58.437
pid_ki = 2.347
pid_kd = 363.769




[fan_generic Bed_Fans]
pin: PA6    #FAN0
max_power: 1.0
shutdown_speed: 0
kick_start_time: 0.5
off_below: 0.19

[output_pin DISABLE_BED_FANS]
pin: PF13    #PS-ON port




#####################################################################
#   SENSORS
#####################################################################
[temperature_sensor Chamber_Temp]
## Chamber Temperature - TH1
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PC5
# min_temp: 0
# max_temp: 200
# gcode_id: chamber_th

[temperature_sensor PI]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor Octopus-Max]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor EBB36]
sensor_type: temperature_mcu
sensor_mcu: EBB36
min_temp: 0
max_temp: 100




#####################################################################
#   CHAMBER LIGHTS
#####################################################################

[output_pin Night_Lights]
pin: PF7
pwm: True
cycle_time: 0.01








#####################################################################
#   Macros
#####################################################################
[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} Z30  

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G90
    G28
    QUAD_GANTRY_LEVEL
    G28
    PARK
    RESTORE_GCODE_STATE NAME=STATE_G32
   
# [gcode_macro PRINT_START]
# #   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
# gcode:
#     G32                            ; home all axes
#     G90                            ; absolute positioning
#     G1 Z20 F3000                   ; move nozzle away from bed
   

# [gcode_macro PRINT_END]
# #   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
# gcode:
#     # safe anti-stringing move coords
#     {% set th = printer.toolhead %}
#     {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
#     {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
#     {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
#     SAVE_GCODE_STATE NAME=STATE_PRINT_END

#     M400                           ; wait for buffer to clear
#     G92 E0                         ; zero the extruder
#     G1 E-5.0 F1800                 ; retract filament
    
#     TURN_OFF_HEATERS

#     G90                                      ; absolute positioning
#     G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
#     G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
#     M107                                     ; turn off fan
    
#     BED_MESH_CLEAR

#     # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
#     # command pair is to restore the printer's coordinate system
#     # and speed settings since the commands above change them.
#     # However, to prevent any accidental, unintentional toolhead
#     # moves when restoring the state, explicitly set MOVE=0.
#     RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0




[gcode_macro enable_stepper]
gcode:
 SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
 SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
 SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
 SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1


[motors_sync]
accel_chip: adxl345
#    Accelerometer for collecting vibrations adxl345 / mpu9250 / lis2dw, etc.
microsteps: 16
#    Maximum microstepping of stepper motor rotor displacement, not worth
#    increase the value above 16, do so at your own peril and risk.
#steps_coeff: 999999 (deprecated steps_threshold)
#    Coefficient of number of microsteps of shaft displacement, depending 
#    on the magnitude value (impact), adjusted experimentally. Let's say
#    if our impact was 50,000 units, and the coeff was 10,000 - the motor
#    will move in 5 microsteps at a time to save time.
fast_threshold: 999999
#    Threshold up to which the motor will not perform decaying oscillations,
#    to save time, due to the already high deviations. Be very be careful
#    when decreasing the value of this parameter.
retry_tolerance: 999999
#    Forced threshold to which a pair of stepper motors should will omit
#    deviations. After several runs calibration, you will find the limit 
#    to which you can lower this parameter.
retries: 0
#    Maximum number of repetitions to achieve forced motor synchronization
#    deviation threshold.
respond: True
#    Enable / disable debugging of intermediate measurements.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [stepper_z]
#*# position_endstop = 0.270

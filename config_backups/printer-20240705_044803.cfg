[include shell_command.cfg]





# [include DEMON_ESSENTIALS/*.cfg]
[include Macros.cfg]
[include cartographer_probe.cfg]
# [include nozzle_adxl.cfg]
[include K-ShakeTune/*.cfg]
[include stealthburner_leds.cfg]
[include DANGER.cfg]

[include mainsail.cfg]
# [exclude_object]
# [pause_resume]
# [display_status]
# [gcode_arcs]
# resolution: 0.1
# [respond]
# default_type: command
# [force_move]
# enable_force_move: True
# [virtual_sdcard]
# path: /home/biqu/printer_data/gcodes
# on_error_gcode: CANCEL_PRINT

[firmware_retraction]
retract_length = 0.4
retract_speed = 30
unretract_speed = 30

###
###
###

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_1C0019000C51313236343430-if00


###
###
###

[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 3000             #Max 4000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

###
###
###

[input_shaper]
shaper_freq_x: 83.2
shaper_freq_y: 61.2
shaper_type_x: mzv
shaper_type_y: mzv
damping_ratio_x: 0.044
damping_ratio_y: 0.059

###
###
###


[stepper_x]
step_pin: PC13
dir_pin: !PC14
enable_pin: !PE6
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: tmc5160_stepper_x:virtual_endstop
position_min: 0
position_endstop: 345
position_max: 345
homing_speed: 150   #Max 100
homing_retract_dist: 0
homing_positive_dir: true
use_sensorless_homing: true


[tmc5160 stepper_x] 
cs_pin: PG14
spi_software_miso_pin: PE13
spi_software_mosi_pin: PE14
spi_software_sclk_pin: PE12
diag1_pin: ^!PF0
interpolate: True
driver_SGT: 3       # -64 is most sensitive value, 63 is least sensitive
run_current: 2.0
home_current: 0.75
sense_resistor: 0.075
stealthchop_threshold: 0


[stepper_x1]
step_pin: PE4
dir_pin: !PE5
enable_pin: !PE3
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper



[tmc5160 stepper_x1] 
cs_pin: PG13
spi_software_miso_pin: PE13
spi_software_mosi_pin: PE14
spi_software_sclk_pin: PE12
interpolate: True
run_current: 2.0
home_current: 0.1
sense_resistor: 0.075
stealthchop_threshold: 0


##############################################

[stepper_y] # Connected to motor 4
step_pin: PB8
dir_pin: !PB9
enable_pin: !PB7
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: tmc5160_stepper_y:virtual_endstop
position_min: 0
position_endstop: 365
position_max: 365
homing_speed: 150  #Max 100
homing_retract_dist: 0
homing_positive_dir: True
use_sensorless_homing: true


[tmc5160 stepper_y] 
cs_pin: PG11
spi_software_miso_pin: PE13
spi_software_mosi_pin: PE14
spi_software_sclk_pin: PE12
diag1_pin: ^!PF3
interpolate: True
driver_SGT: 2   #-1   # -64 is most sensitive value, 63 is least sensitive
run_current: 2.0
home_current: 0.8
sense_resistor: 0.075
stealthchop_threshold: 0


[stepper_y1] # Connected to motor 5
step_pin: PB5
dir_pin: !PB4
enable_pin: !PB6
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper


[tmc5160 stepper_y1] 
cs_pin: PG10
spi_software_miso_pin: PE13
spi_software_mosi_pin: PE14
spi_software_sclk_pin: PE12
interpolate: True
run_current: 2.0
home_current: 0.1
sense_resistor: 0.075
stealthchop_threshold: 0


# #####################################################################
# #   Z Stepper Settings
# #####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PG15
dir_pin: !PB3
enable_pin: !PD5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
endstop_pin: probe:z_virtual_endstop # use cartographer as virtual endstop         #PF4
##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##  Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
# position_endstop: -0.09  #0.5 #0.425
position_max: 310
position_min: -5
homing_speed: 8
# second_homing_speed: 3
homing_retract_dist: 0   #3

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PG9
interpolate: false
run_current: 1.0
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z1 Stepper - Rear Left
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PD3
dir_pin: PD2
enable_pin: !PD4
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: PD7
interpolate: false
run_current: 1.0
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z2 Stepper - Rear Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PA10
dir_pin: !PA9
enable_pin: !PA15
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: PD6
interpolate: false
run_current: 1.0
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z3 Stepper - Front Right
##  Connected to MOTOR_5
[stepper_z3]
step_pin: PA8
dir_pin: PC7
enable_pin: !PC9
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z3]
uart_pin: PG8
interpolate: false
run_current: 1.0
sense_resistor: 0.110
stealthchop_threshold: 0


# #####################################################################
# #   Extruder
# #####################################################################
[extruder]
step_pin: PE1               #EBB36: PD0
dir_pin: !PE0                #EBB36: PD1
enable_pin: !PE2             #!EBB36:PD2
rotation_distance: 47.088   
gear_ratio: 9:1
microsteps: 32
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PF9                #EBB36:PB13
sensor_type: PT1000    #MAX31865  #ATC Semitec 104NT-4-R025H42G
sensor_pin: PA7           #EBB36:PA3
pullup_resistor: 2200            
min_temp: 10
max_temp: 320
max_power: 1.0
min_extrude_temp: 10
pressure_advance: 0.05
pressure_advance_smooth_time: 0.040
# control = pid
# pid_kp = 24.517
# pid_ki = 1.444
# pid_kd = 104.093


#control: mpc
heater_power: 62  
cooling_fan: fan
filament_density: 1.11    #ABS-CF/GF 
filament_heat_capacity: 1.8
ambient_temp_sensor: temperature_sensor chamber

[tmc2209 extruder]
uart_pin: PG12             #EBB36: PA15
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 999999

#############################

[fan]
##	Part Cooling Fan
pin: !PA5
max_power: 1
min_power: 0.10
cycle_time: 0.010   #0.002
hardware_pwm: false
shutdown_speed: 0


[output_pin CPAP_Power]
pin: PA0
pwm: false
value: 1
shutdown_value: 0

############################

[heater_fan hotend_fan]
pin: PA3     # FAN3    5v hotend heatbreak fan
max_power: 1.0
kick_start_time: 0.100
heater: extruder
heater_temp: 50.0
#  If you are experiencing back flow, you can reduce fan_speed
fan_speed: 1.0

#####################################################################
#   Bed Heater
#####################################################################
[heater_bed]
heater_pin: PF6
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PB1
max_power: 1.0
min_temp: 0
max_temp: 200
control = pid
pid_kp = 58.437
pid_ki = 2.347
pid_kd = 363.769




[fan_generic Bed_Fans]
pin: PA6    #FAN0
max_power: 1.0
shutdown_speed: 0
kick_start_time: 0.5
off_below: 0.19

[output_pin DISABLE_BED_FANS]
pin: PF13    #PS-ON port




#####################################################################
#   SENSORS
#####################################################################
[temperature_sensor chamber]  ## Chamber Temperature - TH1
sensor_type:  NTC 100K MGB18-104F39050L32
sensor_pin:   PC5

[temperature_sensor PI]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor Octopus-Max]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100


#####################################################################
#   CHAMBER LIGHTS
#####################################################################

[output_pin Night_Lights]
pin: PF7
pwm: True
cycle_time: 0.01








#####################################################################
#   Macros
#####################################################################

[idle_timeout]
timeout: 7200  # 2 hours
gcode:
    # features
    {% set ena_debug = printer.save_variables.variables.debug|default("false")|lower %}
    {% set ena_exhaust_fan = printer["gcode_macro _COMMON_VARIABLE"].exhaust_fan|lower %}
    {% set ena_nevermore_fan = printer["gcode_macro _COMMON_VARIABLE"].nevermore_fan|lower %}

    {% if ena_debug == "true" %}
        {action_respond_info("==== idle_timeout ====")}
        {action_respond_info("features [exhaust_fan: '%s', nevermore_fan: '%s']" % (ena_exhaust_fan,ena_nevermore_fan))}
        {action_respond_info("===============")}
    {% endif %}

    {% if printer.webhooks.state == "ready" %}
        {action_respond_info("POWER: Execute Idle Timeout")}
        TURN_OFF_HEATERS
        M84
        _SET_LED_STATE_BY_NAME STATE="standby"

        {% if ena_nevermore_fan == "true" %}
            SET_FAN_SPEED FAN=nevermore_fan SPEED=0
        {% endif %}
        {% if ena_exhaust_fan == "true" %}
            SET_FAN_SPEED FAN=exhaust_fan SPEED=0
        {% endif %}
    {% endif %}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_version = 1
#*# pid_target = 270.00
#*# pid_tolerance = 0.0200
#*# pid_kp = 24.517
#*# pid_ki = 1.444
#*# pid_kd = 104.093
#*# control = mpc
#*# block_heat_capacity = 16.9866
#*# sensor_responsiveness = 0.0496800
#*# ambient_transfer = 0.130264
#*# fan_ambient_transfer = 0.130264, 0.15111, 0.164697
#*#
#*# [cartographer model default]
#*# model_coef = 1.3808673909252607,
#*# 	  1.7988775827116206,
#*# 	  0.7858755519288266,
#*# 	  0.36477116980805396,
#*# 	  0.26595751204048745,
#*# 	  0.3626741997535084,
#*# 	  -0.08769585332674024,
#*# 	  -0.32632926382744415,
#*# 	  0.2052094464058377,
#*# 	  0.2518860136363609
#*# model_domain = 3.1939223575856307e-07,3.3312348076219734e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 65.875541
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.161277, -0.158617, -0.156353, -0.156782, -0.157324, -0.157289, -0.155519, -0.152089, -0.148465, -0.114225, -0.102211, -0.121639, -0.110909, -0.102447, -0.095255, -0.092724, -0.092260, -0.095768, -0.099672, -0.103945, -0.111306, -0.117760, -0.123489, -0.128029, -0.135599
#*# 	-0.177127, -0.175491, -0.175865, -0.174377, -0.176044, -0.174105, -0.172033, -0.168110, -0.161269, -0.127794, -0.121371, -0.132051, -0.118196, -0.107803, -0.098963, -0.094401, -0.092963, -0.096454, -0.101220, -0.106901, -0.111597, -0.118177, -0.120623, -0.127977, -0.134465
#*# 	-0.184028, -0.184030, -0.183623, -0.186181, -0.187864, -0.184680, -0.181442, -0.174349, -0.165891, -0.130545, -0.115952, -0.122422, -0.118302, -0.107040, -0.097992, -0.092342, -0.089652, -0.091004, -0.095360, -0.100608, -0.102696, -0.106512, -0.113348, -0.120975, -0.129274
#*# 	-0.197585, -0.194122, -0.193955, -0.196129, -0.197072, -0.195966, -0.193810, -0.184881, -0.176106, -0.164352, -0.134095, -0.122028, -0.117620, -0.105953, -0.098712, -0.092843, -0.086311, -0.085857, -0.087166, -0.092560, -0.095604, -0.099623, -0.106292, -0.114454, -0.121798
#*# 	-0.208128, -0.206850, -0.205555, -0.204859, -0.209140, -0.211413, -0.208893, -0.203597, -0.194422, -0.179702, -0.159459, -0.139558, -0.121196, -0.109115, -0.103592, -0.095444, -0.087657, -0.084180, -0.084820, -0.088065, -0.092386, -0.098962, -0.105282, -0.113389, -0.120467
#*# 	-0.210816, -0.209452, -0.209059, -0.211545, -0.216561, -0.221462, -0.220782, -0.218857, -0.210355, -0.192270, -0.168625, -0.143805, -0.120716, -0.108038, -0.099523, -0.090780, -0.082205, -0.078038, -0.075615, -0.077823, -0.082565, -0.089040, -0.094420, -0.104559, -0.115628
#*# 	-0.204475, -0.200882, -0.199874, -0.204892, -0.211665, -0.218528, -0.222505, -0.222790, -0.214713, -0.195163, -0.168005, -0.137077, -0.113359, -0.094698, -0.083217, -0.073073, -0.065558, -0.061278, -0.060168, -0.064642, -0.066128, -0.071849, -0.080897, -0.092677, -0.101835
#*# 	-0.194104, -0.191666, -0.191395, -0.196700, -0.205120, -0.213469, -0.220455, -0.223185, -0.214828, -0.193033, -0.160762, -0.127552, -0.098345, -0.077957, -0.063379, -0.049824, -0.039789, -0.038788, -0.043475, -0.046938, -0.051737, -0.059505, -0.069673, -0.078957, -0.087634
#*# 	-0.190765, -0.187230, -0.186617, -0.191134, -0.198253, -0.207973, -0.217249, -0.221938, -0.212434, -0.188399, -0.152108, -0.114533, -0.083533, -0.059623, -0.044772, -0.029838, -0.021191, -0.023185, -0.030207, -0.037029, -0.044988, -0.052585, -0.060700, -0.071228, -0.080078
#*# 	-0.188410, -0.183853, -0.182151, -0.183869, -0.190466, -0.196414, -0.204353, -0.207661, -0.196808, -0.171685, -0.132092, -0.093251, -0.061826, -0.038708, -0.024243, -0.014016, -0.006411, -0.010022, -0.019606, -0.025485, -0.033213, -0.040554, -0.050739, -0.063750, -0.074796
#*# 	-0.190136, -0.184272, -0.178499, -0.178344, -0.182438, -0.183564, -0.182961, -0.181632, -0.168598, -0.143083, -0.106659, -0.069353, -0.040731, -0.020027, -0.008744, -0.000401, 0.002027, -0.002916, -0.010427, -0.019590, -0.028555, -0.036328, -0.047063, -0.056805, -0.068319
#*# 	-0.189022, -0.181932, -0.174146, -0.173558, -0.172901, -0.167437, -0.158609, -0.149749, -0.133676, -0.107356, -0.074714, -0.042926, -0.015980, 0.000185, 0.006990, 0.011233, 0.012119, 0.008035, 0.000943, -0.009125, -0.018767, -0.028236, -0.039523, -0.050075, -0.064897
#*# 	-0.196586, -0.187076, -0.180378, -0.176082, -0.170378, -0.158909, -0.144552, -0.127828, -0.107749, -0.081539, -0.051100, -0.021631, 0.001256, 0.014438, 0.018569, 0.019666, 0.018267, 0.010969, 0.001359, -0.006352, -0.018848, -0.030857, -0.043373, -0.054856, -0.068737
#*# 	-0.195085, -0.187391, -0.179334, -0.174186, -0.163261, -0.147964, -0.127273, -0.106543, -0.083101, -0.054167, -0.023678, 0.005450, 0.026703, 0.037082, 0.036820, 0.036984, 0.031475, 0.023044, 0.010741, -0.001711, -0.015492, -0.030034, -0.041978, -0.056257, -0.067920
#*# 	-0.206086, -0.197327, -0.187931, -0.180583, -0.167497, -0.146820, -0.124773, -0.100247, -0.074045, -0.041686, -0.005429, 0.027202, 0.050725, 0.059110, 0.056097, 0.051700, 0.041022, 0.027996, 0.013912, -0.000497, -0.014601, -0.030247, -0.043247, -0.055833, -0.068988
#*# 	-0.224717, -0.214298, -0.203302, -0.192668, -0.177730, -0.162138, -0.141379, -0.115763, -0.084623, -0.044389, -0.001214, 0.041554, 0.070657, 0.076143, 0.063731, 0.048044, 0.034226, 0.018053, 0.004155, -0.010606, -0.025073, -0.041092, -0.053298, -0.068713, -0.082405
#*# 	-0.236764, -0.225141, -0.207707, -0.192939, -0.191808, -0.179402, -0.161878, -0.136454, -0.097416, -0.049510, 0.004930, 0.055279, 0.089105, 0.093321, 0.075141, 0.051048, 0.032192, 0.014779, 0.000346, -0.014819, -0.030408, -0.043362, -0.057980, -0.075313, -0.087872
#*# 	-0.239853, -0.228942, -0.216230, -0.207117, -0.204984, -0.194911, -0.180505, -0.157473, -0.115697, -0.055268, 0.011647, 0.067822, 0.101335, 0.102887, 0.082106, 0.054627, 0.031816, 0.014376, -0.001042, -0.018188, -0.029372, -0.042640, -0.056559, -0.072420, -0.090575
#*# 	-0.238827, -0.230149, -0.221813, -0.218492, -0.213506, -0.207992, -0.202846, -0.182484, -0.139868, -0.073127, 0.000396, 0.061228, 0.094464, 0.095159, 0.073295, 0.047663, 0.027035, 0.009384, -0.006652, -0.018383, -0.030692, -0.043372, -0.057868, -0.076789, -0.093386
#*# 	-0.231647, -0.225049, -0.220230, -0.218146, -0.213519, -0.212625, -0.212490, -0.197984, -0.161909, -0.098150, -0.024401, 0.036455, 0.071308, 0.073692, 0.057195, 0.036187, 0.018522, 0.002878, -0.009531, -0.023083, -0.034900, -0.047838, -0.062749, -0.081776, -0.099993
#*# 	-0.220586, -0.217314, -0.213487, -0.210889, -0.210036, -0.212571, -0.212781, -0.205532, -0.178209, -0.122043, -0.052957, 0.006793, 0.041906, 0.048821, 0.037551, 0.022781, 0.008849, -0.004109, -0.016754, -0.032242, -0.045368, -0.056932, -0.070826, -0.091806, -0.111202
#*# 	-0.219057, -0.214919, -0.211147, -0.207399, -0.206763, -0.209366, -0.213467, -0.211793, -0.190753, -0.144060, -0.081835, -0.026754, 0.008217, 0.017494, 0.011529, 0.000764, -0.007550, -0.019007, -0.033005, -0.051435, -0.067922, -0.079420, -0.094298, -0.110218, -0.126180
#*# 	-0.221158, -0.216122, -0.210650, -0.208794, -0.204629, -0.207705, -0.211577, -0.212831, -0.198260, -0.160313, -0.105212, -0.053658, -0.023182, -0.010598, -0.011224, -0.017789, -0.026455, -0.038642, -0.052313, -0.072366, -0.089707, -0.104155, -0.117681, -0.131706, -0.144974
#*# 	-0.209622, -0.203536, -0.199424, -0.194555, -0.193306, -0.195497, -0.198187, -0.200150, -0.189113, -0.158126, -0.108395, -0.061673, -0.035444, -0.025736, -0.023116, -0.025580, -0.031978, -0.044609, -0.059858, -0.078464, -0.097246, -0.109299, -0.121508, -0.138291, -0.152947
#*# 	-0.171514, -0.169464, -0.165221, -0.163465, -0.163911, -0.165439, -0.168516, -0.167948, -0.160691, -0.136240, -0.094321, -0.056633, -0.032192, -0.020978, -0.017993, -0.019990, -0.024287, -0.032782, -0.047648, -0.065410, -0.084224, -0.095433, -0.105621, -0.121772, -0.134889
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 310.0
#*# min_y = 40.0
#*# max_y = 310.0
